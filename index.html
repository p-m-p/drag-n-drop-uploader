<!DOCTYPE html>  <html> <head>   <title>uploader.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               uploader.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>Uploader</h2>

<p>A HTML5 image uploader application which accepts files from a file input 
field or files that are dropped directly onto the list of uploads in the UI.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">;(</span><span class="kd">function</span> <span class="p">(</span><span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>

  <span class="s1">&#39;use strict&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Create the main Uploader object with the default settings</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">up</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">Uploader</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The template for the upload list items. The template is built with the
<a href="http://lodash.com/docs#template">templating functionality in lodash</a></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;upload-tmpl&#39;</span><span class="p">).</span><span class="nx">innerHTML</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The list in the UI to which uploads will be added</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">fileList</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;file-uploads&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The maximum number of concurrent active uploads</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">MAX_ACTIVE_UPLOADS</span><span class="o">:</span> <span class="mi">5</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>A list for uploads that are waiting for a free slot to start running</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">queue</span><span class="o">:</span> <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>A list for the uploads that are actively uploading </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">activeUploads</span><span class="o">:</span> <span class="p">[]</span> </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Internal tracker for the number of uploads that have been added</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">uploadCount</span><span class="o">:</span> <span class="mi">0</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Sets up the initial state of the application. Bind event handlers for the
UI controls</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">up</span><span class="p">.</span><span class="nx">setup</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Listen for changes on the file field and automatically upload any
selected files</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nb">document</span>
      <span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;input[type=file]&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">up</span><span class="p">.</span><span class="nx">uploadFromFileField</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Listen for any clicks on the file upload "remove" links</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">fileList</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">up</span><span class="p">.</span><span class="nx">removeUpload</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Handle the drag and drop for adding files directly to the upload list</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">fileList</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;dragover&#39;</span><span class="p">,</span> <span class="nx">up</span><span class="p">.</span><span class="nx">stopEvent</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span> 
    <span class="k">this</span><span class="p">.</span><span class="nx">fileList</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span> <span class="nx">up</span><span class="p">.</span><span class="nx">handleDrop</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span> 
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Remove an upload from the list when it's "remove" link is clicked</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">up</span><span class="p">.</span><span class="nx">removeUpload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">li</span><span class="p">,</span> <span class="nx">activeUpload</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Make sure the event was triggered by clicking a remove link </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Fetch the list item for which the remove button was clicked</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">li</span> <span class="o">=</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">li</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>The upload may be active so attempt to remove it from the list of 
active uploads</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">activeUpload</span> <span class="o">=</span> <span class="nx">up</span><span class="p">.</span><span class="nx">removeActiveUploadById</span><span class="p">(</span><span class="nx">li</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">uploadId</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>If it is an active upload abort the request and let the next queued
upload start</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">activeUpload</span> <span class="o">&amp;&amp;</span> <span class="nx">activeUpload</span><span class="p">.</span><span class="nx">_xhr</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">activeUpload</span><span class="p">.</span><span class="nx">_xhr</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
          <span class="nx">up</span><span class="p">.</span><span class="nx">nextUpload</span><span class="p">();</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Remove the list item from the upload list in the UI</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">up</span><span class="p">.</span><span class="nx">fileList</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">li</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">ev</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Get the files dropped on the upload list and send them to be uploaded</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">up</span><span class="p">.</span><span class="nx">handleDrop</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">up</span><span class="p">.</span><span class="nx">stopEvent</span><span class="p">(</span><span class="nx">ev</span><span class="p">);</span>
    <span class="nx">up</span><span class="p">.</span><span class="nx">uploadFiles</span><span class="p">(</span><span class="nx">up</span><span class="p">.</span><span class="nx">filterImages</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">files</span><span class="p">));</span> 
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Get the selected files from the file field send them to be uploaded</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">up</span><span class="p">.</span><span class="nx">uploadFromFileField</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">up</span><span class="p">.</span><span class="nx">uploadFiles</span><span class="p">(</span><span class="nx">up</span><span class="p">.</span><span class="nx">filterImages</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">files</span><span class="p">));</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Upload each file in fileList</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">up</span><span class="p">.</span><span class="nx">uploadFiles</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fileList</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Create a fragment to add the list items to as there may be many</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">frag</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">();</span>

    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">fileList</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Create a data URI to display a small thumbnail of the image being
uploaded</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
        <span class="p">,</span> <span class="nx">li</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="nx">uploadId</span> <span class="o">=</span> <span class="p">(</span><span class="nx">up</span><span class="p">.</span><span class="nx">uploadCount</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Create the list item using the lodash template</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">li</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">up</span><span class="p">.</span><span class="nx">template</span><span class="p">({</span>
          <span class="nx">name</span><span class="o">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span>
        <span class="p">,</span> <span class="nx">size</span><span class="o">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">size</span>
        <span class="p">,</span> <span class="nx">dataURL</span><span class="o">:</span> <span class="nx">url</span>
      <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Give the upload an id incase it needs to be fetched for cancellation</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">li</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">uploadId</span> <span class="o">=</span> <span class="nx">uploadId</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Add the list item to the fragment and revoke the data URI</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">frag</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">li</span><span class="p">);</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">revokeObjectURL</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Create an object with all of the upload details and send it to queued
for uploading</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">up</span><span class="p">.</span><span class="nx">queueUpload</span><span class="p">({</span>
          <span class="nx">id</span><span class="o">:</span> <span class="nx">uploadId</span>
        <span class="p">,</span> <span class="nx">file</span><span class="o">:</span> <span class="nx">file</span>
        <span class="p">,</span> <span class="nx">listItem</span><span class="o">:</span> <span class="nx">li</span>
      <span class="p">});</span>
    <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Append the files contained in the fragment to the file list in the UI</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">fileList</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">frag</span><span class="p">);</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Queue a file for uploading. If there is space in the list of active
uploads then it is added directly to the active uploads and started as
there is no need to wait</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">up</span><span class="p">.</span><span class="nx">queueUpload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">upload</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Check available upload slots</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">up</span><span class="p">.</span><span class="nx">activeUploads</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">up</span><span class="p">.</span><span class="nx">MAX_ACTIVE_UPLOADS</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Add to active uploads and start</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">up</span><span class="p">.</span><span class="nx">activeUploads</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">upload</span><span class="p">);</span>
      <span class="nx">up</span><span class="p">.</span><span class="nx">startUpload</span><span class="p">(</span><span class="nx">upload</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Add to the upload to the bottom of queue stack</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">up</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">upload</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Starts a file upload and sets up all of the associated event handlers</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">up</span><span class="p">.</span><span class="nx">startUpload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">upload</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Add a reference to the Ajax request on the upload object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">upload</span><span class="p">.</span><span class="nx">_xhr</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>And likewise add a reference to the upload object on the Ajax request
and it's associated request upload so that it is easy to update the UI
state in the event handlers</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">xhr</span><span class="p">.</span><span class="nx">_file_upload</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">upload</span><span class="p">.</span><span class="nx">_file_upload</span> <span class="o">=</span> <span class="nx">upload</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Open the request and set the event listeners</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;upload.php&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">up</span><span class="p">.</span><span class="nx">uploadComplete</span><span class="p">;</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">up</span><span class="p">.</span><span class="nx">uploadError</span><span class="p">;</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">upload</span><span class="p">.</span><span class="nx">onprogress</span> <span class="o">=</span> <span class="nx">up</span><span class="p">.</span><span class="nx">updateProgressIndicator</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Send the File object as the Ajax request body</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">upload</span><span class="p">.</span><span class="nx">file</span><span class="p">);</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Event handler that runs when the file upload Ajax request has completed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">up</span><span class="p">.</span><span class="nx">uploadComplete</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">li</span><span class="p">,</span> <span class="nx">nextUpload</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Ensure that the file upload object set on the Ajax request referenced
using the this keyword exists</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_file_upload</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Get the UI list item so that it can be updated</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">li</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_file_upload</span><span class="p">.</span><span class="nx">listItem</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Ensure the progress bar is set to complete state</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">li</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.progress&#39;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="s1">&#39;100%&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Add complete class to the list item</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">li</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;complete&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Update the application state now that this upload has finished and 
set the next upload to start</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">up</span><span class="p">.</span><span class="nx">clearUpload</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Update the state of the UI if the upload fails</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">up</span><span class="p">.</span><span class="nx">uploadError</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">li</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Ensure that the reference to the upload can be retrieved</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_file_upload</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Set the error state of the list item by adding the error class</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">li</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_file_upload</span><span class="p">.</span><span class="nx">listItem</span><span class="p">;</span>
      <span class="nx">li</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Clean up the application state</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">up</span><span class="p">.</span><span class="nx">clearUpload</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Update the uploads progress indicator with the percentage of the upload
that has successfully uploaded</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">up</span><span class="p">.</span><span class="nx">updateProgressIndicator</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">li</span><span class="p">,</span> <span class="nx">pctLoaded</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Ensure the progress can be obtained from the event object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">lengthComputable</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_file_upload</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Update the width of the progress bar in the list item to the 
percentage of the file that has uploaded</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">li</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_file_upload</span><span class="p">.</span><span class="nx">listItem</span><span class="p">;</span>
      <span class="nx">pctLoaded</span> <span class="o">=</span> <span class="p">((</span><span class="nx">ev</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">/</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
      <span class="nx">li</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.progress&#39;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">pctLoaded</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Set the next upload to start, if it exists</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">up</span><span class="p">.</span><span class="nx">nextUpload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">up</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>If there is a queued upload</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Add it the list of active uploads and start it</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">up</span><span class="p">.</span><span class="nx">activeUploads</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>
      <span class="nx">up</span><span class="p">.</span><span class="nx">startUpload</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Remove and return the upload with the matching id from the list of
active uploads. If it does not exist undefined is returned</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">up</span><span class="p">.</span><span class="nx">removeActiveUploadById</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">uploadId</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">activeUpload</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Check each upload to see if it has a matching id</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">up</span><span class="p">.</span><span class="nx">activeUploads</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">upload</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>If the id matches then set the return variable and remove it from
the list of active uploads</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">upload</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="o">+</span><span class="nx">uploadId</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">activeUpload</span> <span class="o">=</span> <span class="nx">upload</span><span class="p">;</span>
        <span class="nx">up</span><span class="p">.</span><span class="nx">activeUploads</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">up</span><span class="p">.</span><span class="nx">activeUploads</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">upload</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>No further need to check any other active uploads</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">activeUpload</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Filter the file list and return an array of only the images</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">up</span><span class="p">.</span><span class="nx">filterImages</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fileList</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Set up a Regex to check the file types agaist</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">acceptedType</span> <span class="o">=</span> <span class="sr">/^image\//</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Test each files type to ensure it is an image of some type</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">fileList</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>If the test passes and it is an image add it to the filtered list</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">acceptedType</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Remove the active upload and kill any references</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">up</span><span class="p">.</span><span class="nx">clearUpload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">upload</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">_file_upload</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Ensure the reference to the file upload can be retrieved</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">upload</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Remove the active upload</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">up</span><span class="p">.</span><span class="nx">activeUploads</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">up</span><span class="p">.</span><span class="nx">activeUploads</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">upload</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Delete the reference on the upload to the Ajax request</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">delete</span> <span class="nx">upload</span><span class="p">.</span><span class="nx">xhr</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Delete the reference to the file upload object on the Ajax request
and it's associated upload</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">delete</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">_file_upload</span><span class="p">;</span>
    <span class="k">delete</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">upload</span><span class="p">.</span><span class="nx">_file_upload</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Start the next upload</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">up</span><span class="p">.</span><span class="nx">nextUpload</span><span class="p">();</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Stop the default action of an event and prevent it propagating</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">up</span><span class="p">.</span><span class="nx">stopEvent</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ev</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
    <span class="nx">ev</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Do it!</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">up</span><span class="p">.</span><span class="nx">setup</span><span class="p">();</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 